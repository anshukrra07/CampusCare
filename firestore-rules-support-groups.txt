// Add these rules to your existing firestore.rules file

// Support Groups Collection
match /supportGroups/{groupId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null && 
    request.auth.uid == resource.data.createdBy;
  allow update: if request.auth != null && (
    request.auth.uid == resource.data.createdBy ||
    request.auth.uid in resource.data.moderators ||
    // Allow users to join/leave groups by updating membersList
    (request.writeFields == ['membersList', 'members', 'updatedAt'] &&
     request.auth.uid in request.resource.data.membersList)
  );
  allow delete: if request.auth != null && 
    request.auth.uid == resource.data.createdBy;
    
  // Group messages subcollection
  match /messages/{messageId} {
    allow read, write: if request.auth != null && 
      request.auth.uid in get(/databases/$(database)/documents/supportGroups/$(groupId)).data.membersList;
  }
}

// User document updates for joined groups
match /users/{userId} {
  allow read, update: if request.auth != null && request.auth.uid == userId;
}